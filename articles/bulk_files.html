<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Querying bulk files from the API ‚Ä¢ comtradr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Querying bulk files from the API">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">comtradr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.4.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/comtradr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/bulk_files.html">Querying bulk files from the API</a>
    </li>
    <li>
      <a href="../articles/caching.html">Caching requests from the UN Comtrade API</a>
    </li>
    <li>
      <a href="../articles/large_data.html">Querying large amounts of data</a>
    </li>
    <li>
      <a href="../articles/transition.html">Transition from old comtradr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/comtradr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Querying bulk files from the API</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/comtradr/blob/main/vignettes/bulk_files.Rmd" class="external-link"><code>vignettes/bulk_files.Rmd</code></a></small>
      <div class="hidden name"><code>bulk_files.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/comtradr/" class="external-link">comtradr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="why-use-bulk-files">Why use bulk files? üì¶üì¶üì¶<a class="anchor" aria-label="anchor" href="#why-use-bulk-files"></a>
</h3>
<p>When you are on the free API tier, you can get relatively large
amounts of data already. I explained this <a href="https://docs.ropensci.org/comtradr/articles/large_data.html" class="external-link">here</a>.
There is essentially two reasons why you still want to use
bulk-files.</p>
<ol style="list-style-type: lower-alpha">
<li>you want to get A LOT more data, in like hundreds of millions of
rows</li>
<li>you want to get consistent HS codes across years.</li>
</ol>
<p>While a) is certainly a possibility, b) is a lot more likely and a
very common scenario. I will focus on explaining b) in the
following.</p>
<div class="section level4">
<h4 id="accounting-for-hs-code-changes">Accounting for HS Code changes üèóÔ∏èüë∑<a class="anchor" aria-label="anchor" href="#accounting-for-hs-code-changes"></a>
</h4>
<p>Let us assume, you want to compare the amount of imported shrimp from
other countries into the EU. You could use HS code <a href="https://www.trade-tariff.service.gov.uk/headings/0306" class="external-link">3003</a>
for this purpose and query the data for this across the last 30 years.
In the free tier API this would look similar to something like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hs0</span> <span class="op">&lt;-</span> <span class="fu">comtradr</span><span class="fu">::</span><span class="fu"><a href="../reference/ct_get_data.html">ct_get_data</a></span><span class="op">(</span></span>
<span>  reporter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DEU"</span>,<span class="st">"FRA"</span><span class="op">)</span>, <span class="co"># only some examples here,</span></span>
<span>  commodity_classification <span class="op">=</span> <span class="st">'HS'</span>,</span>
<span>  commodity_code <span class="op">=</span> <span class="st">'0306'</span>,</span>
<span>  start_date <span class="op">=</span> <span class="fl">1990</span>, <span class="co"># only one year here</span></span>
<span>  end_date <span class="op">=</span> <span class="fl">1990</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hs5</span> <span class="op">&lt;-</span> <span class="fu">comtradr</span><span class="fu">::</span><span class="fu"><a href="../reference/ct_get_data.html">ct_get_data</a></span><span class="op">(</span></span>
<span>  reporter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DEU"</span>,<span class="st">"FRA"</span><span class="op">)</span>, <span class="co"># only some examples here,</span></span>
<span>  commodity_classification <span class="op">=</span> <span class="st">'HS'</span>,</span>
<span>  commodity_code <span class="op">=</span> <span class="st">'0306'</span>,</span>
<span>  start_date <span class="op">=</span> <span class="fl">2020</span>, <span class="co"># only one year here</span></span>
<span>  end_date <span class="op">=</span> <span class="fl">2020</span><span class="op">)</span></span></code></pre></div>
<p>However, as you might not know, the HS code definitions change over
the years. That makes this operation a lot more tricky, because if you
compare the two HS code descriptions for your code, you will see that
they are different!</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hs0</span><span class="op">$</span><span class="va">cmd_desc</span>,<span class="va">hs5</span><span class="op">$</span><span class="va">cmd_desc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Crustaceans, in shell or not, live, fresh, chilled, frozen, dried, salted or in brine; crustaceans, in shell, cooked by steaming or boiling in water, chilled or not, frozen, dried, salted or in brine"                                                     </span></span>
<span><span class="co">#&gt; [2] "Crustaceans; in shell or not, live, fresh, chilled, frozen, dried, salted or in brine; smoked, cooked or not before or during smoking; in shell, steamed or boiled, whether or not chilled, frozen, dried, salted or in brine; edible flours, meals, pellets"</span></span></code></pre></div>
<p>To a degree then, you are comparing Apples with Oranges. Or in this
case, Crustaceans that are smoked with the ones that are not.</p>
<p>Hence, you are not really only seeing actual changes in trading
values, but these might change simply because of changes in
definition.</p>
<p>With the free API tier, you would now have to engage in lengthy
comparisons between different HS codes, e.g.¬†using the <a href="https://github.com/insongkim/concordance" class="external-link">concordance</a>-package.
The package is quite amazing, but the exercise of matching HS codes can
be cumbersome, as there are multiple many-to-many-matches.</p>
</div>
<div class="section level4">
<h4 id="getting-started-with-bulk-files">Getting started with bulk files üèÉ<a class="anchor" aria-label="anchor" href="#getting-started-with-bulk-files"></a>
</h4>
<p>The bulk tier API offers a solution. You can specify which HS
Classification scheme you want to use across all the years you are
interested in. The above code becomes:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hs0_all</span> <span class="op">&lt;-</span> <span class="fu">comtradr</span><span class="fu">::</span><span class="fu"><a href="../reference/ct_get_bulk.html">ct_get_bulk</a></span><span class="op">(</span></span>
<span>  reporter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DEU"</span>,<span class="st">"FRA"</span><span class="op">)</span>, <span class="co"># only some examples here,</span></span>
<span>  commodity_classification <span class="op">=</span> <span class="st">'H0'</span>,</span>
<span>  frequency <span class="op">=</span> <span class="st">'A'</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  start_date <span class="op">=</span> <span class="fl">1990</span>, <span class="co"># only one year here</span></span>
<span>  end_date <span class="op">=</span> <span class="fl">2020</span><span class="op">)</span></span></code></pre></div>
<p>Essentially, the bulk file facility only allows you to list
years/month, reporters and a classification scheme you want to query.
You will then receive one file per period for each reporter. There is
multiple requests involved, which the <code>ct_get_bulk</code> function
will handle for you.</p>
<p>Be careful though, you cannot query individual commodity codes, hence
the datasets you are querying become very large very quickly. The above
query will download more than 3GB of data, which once it is unpacked
becomes even larger.</p>
<p>The bulk function will download this data, unpack it on your
computer, read it in and then delete the files again. This is a costly
operation and you want to think about how much data you will actually
need and after first reading it in save it in a appropriately compressed
file for future use instead of querying it every time you need it (see
e.g.¬†<a href="https://www.fstpackage.org/" class="external-link">fst</a>).</p>
</div>
<div class="section level4">
<h4 id="formatting-bulk-files">Formatting bulk files üìù<a class="anchor" aria-label="anchor" href="#formatting-bulk-files"></a>
</h4>
<p>The bulk files come with less information, in that there is no
descriptive variables included. E.g. partner countries are only included
by code, not by name. Since in most cases we want the description for
plotting and further analysis these need to be merged on. This is very
straight forward with the reference tables included in the package.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reporter</span> <span class="op">&lt;-</span> <span class="fu">comtradr</span><span class="fu">::</span><span class="fu"><a href="../reference/ct_get_ref_table.html">ct_get_ref_table</a></span><span class="op">(</span><span class="st">"reporter"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>    reporter_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,</span>
<span>    reporter_iso <span class="op">=</span> <span class="va">iso_3</span>,</span>
<span>    reporter_desc <span class="op">=</span> <span class="va">country</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">partner</span> <span class="op">&lt;-</span> <span class="fu">comtradr</span><span class="fu">::</span><span class="fu"><a href="../reference/ct_get_ref_table.html">ct_get_ref_table</a></span><span class="op">(</span><span class="st">"partner"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>    partner_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,</span>
<span>    partner_iso <span class="op">=</span> <span class="va">iso_3</span>,</span>
<span>    partner_desc <span class="op">=</span> <span class="va">country</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">flow</span> <span class="op">&lt;-</span> <span class="fu">comtradr</span><span class="fu">::</span><span class="fu"><a href="../reference/ct_get_ref_table.html">ct_get_ref_table</a></span><span class="op">(</span><span class="st">"flow_direction"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>flow_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>, flow_desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clean_data</span> <span class="op">&lt;-</span> <span class="va">hs0_all</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">customs_code</span> <span class="op">==</span> <span class="st">"C00"</span> <span class="op">&amp;</span></span>
<span>                  <span class="va">mot_code</span> <span class="op">==</span> <span class="st">"0"</span> <span class="op">&amp;</span> <span class="va">partner2code</span> <span class="op">==</span> <span class="st">"0"</span><span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">reporter</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">partner</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>    frequency <span class="op">=</span> <span class="va">freq_code</span>,</span>
<span>    <span class="va">reporter_desc</span>,</span>
<span>    <span class="va">reporter_iso</span>,</span>
<span>    <span class="va">partner_desc</span>,</span>
<span>    <span class="va">partner_iso</span>,</span>
<span>    <span class="va">classification_code</span>,</span>
<span>    <span class="va">cmd_code</span>,</span>
<span>    flow_desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">flow_desc</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="va">period</span>,</span>
<span>    <span class="va">customs_code</span>,</span>
<span>    <span class="va">mot_code</span>,</span>
<span>    <span class="va">mos_code</span>,</span>
<span>    <span class="va">partner2code</span>,</span>
<span>    <span class="va">primary_value</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="co">#&gt; Joining with `by = join_by(reporter_code)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(partner_code)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(flow_code)`</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Paul Bochtler, Harriet Goers, Chris Muir.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
